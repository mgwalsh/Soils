---
title: Rating landscape soil aggregate stability from laser diffraction particle size data
author: M.G. Walsh and A. Sila
date: "Last compiled: `r format(Sys.time(), '%d, %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 2
    fig_caption: true
    css: style1.css
---

```{r, echo = FALSE}
knitr::opts_chunk$set(message = FALSE)
```

# Introduction

[Soil aggregate stability](https://www.sciencedirect.com/topics/agricultural-and-biological-sciences/aggregate-stability) refers to the ability of soil aggregates to resist disintegration when disruptive forces associated with e.g., tillage operations and erosion occur. Aggregate stability indicates how well soils can resist compaction, wind abrasion, rainfall detachment and atmospheric and/or overland transport. It is a dynamic structural soil property, which is important for water infiltration, retention and drainage, soil aeration, microbial activity, organic matter storage and stabilization and plant root growth, among others. When unstable soil aggregates disintegrate e.g., during tillage operations or rainstorms, dispersed particles fill soil pore spaces. Plow layer compaction, hardpans and soil crusts can develop. Once such structures are formed, infiltration is reduced, which can result in increased runoff, erosion and reduced water availability for plant growth. Typically, the associated processes will occur in reinforcing feedback loops in landscapes. Changes in aggregate stability can be used as early indicators of soil degradation or recovery and to monitor the effects and impacts of land management interventions. However, conventional approaches that use techniques such as wet sieving and weighing, slake tests or hydrometer and pipetting methods are time consuming and labor intensive. This has largely precluded their operational use in landscape-level assessment and monitoring applications. 

[Laser diffraction particle size analysis (LDPSA)](https://wiki.anton-paar.com/en/laser-diffraction-for-particle-sizing/) under different dispersion treatments in e.g., in air, water and/or sodium hexametaphosphate ([calgon](https://pubchem.ncbi.nlm.nih.gov/compound/Calgon)), with or without [sonication](https://www.sciencedirect.com/topics/engineering/ultrasonication) can serve as indicators of soil particle size distributions and aggregate stability for environmental, ecological and engineering purposes. The big advantage of LDPSA is that it can be performed rapidly (in < 5 minutes) using small (< 5 g) quantities of soil. The method works by passing a soil sample through a laser beam, which scatters the incident light onto a Fourier lens. The lens focuses the scattered laser light onto a detector array using an inversion algorithm, and a particle size distribution is inferred from the collected data. [Mie theory](https://en.wikipedia.org/wiki/Mie_scattering) is applied to provide a compositionally-based distribution of particle sizes based on the correlation between the intensity and the angle of the light that is scattered. The approach generates compositional data ([CoDa](https://link.springer.com/book/10.1007/978-3-642-36809-7)), which are data where all the components are positive numbers that are constrained by a closure form, meaning that they sum up to a constant (e.g., 1 or 100%). Modeling CoDa requires log ratio transformations to retain this inherent closure constraint (see e.g., [Greenacre, 2021](https://www.annualreviews.org/doi/pdf/10.1146/annurev-statistics-042720-124436)).

The main goal of this notebook is to illustrate a workflow for assessing soil aggregate stability in landscapes. It does not go into the details of LDPSA data collections or the associated laboratory analysis procedures (for method references see e.g., [Kerry et.al., (2009)](https://www.sciencedirect.com/science/article/abs/pii/S0016706109002067?via%3Dihub)). Instead, it focuses on the associated statistical steps that are needed to generate potentially useful inferences and predictions for populations of LDPSA measurements in landscapes. We demonstrate [random-effects models](https://www.sciencedirect.com/topics/medicine-and-dentistry/random-effects-model) and [meta-regression](https://www.sciencedirect.com/topics/medicine-and-dentistry/meta-regression) approaches in this context, which take both the CoDa and the ordinal nature of the laboratory dispersal treatments into account.

# Data setup

To actually run this notebook, you will need to load the packages indicated in the chunk directly below. The notebook itself is maintained on [Github](), and you can fork and modify it from there as you see fit.

```{r}
# Package names
packages <- c("osfr", "tidyverse", "compositions", "leaflet", "ggtern", "DT", "ordinal", "metafor")

# Install packages
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# Load packages
invisible(lapply(packages, library, character.only = TRUE))
```

The data needed for running this notebook can be obtained from the Africa Soil Information Service [Open Science Framework](https://www.cos.io/products/osf) repo [here](https://osf.io/yr8ua/). The next chunk reads in the data, calculates the *Isometric Log Ratio* ([ilr]()) transforms and the *Mean Weight Diameter* ([mwd]()) for the soil particle size fractions in different dispersants (air, water or calgon) and sonication time treatments. These will be the LDPSA indicators that are used to model and interpret soil aggregate stability in this notebook.

```{r, results = 'hide'}
# Create a data folder in your current working directory
dir.create("ldpsa", showWarnings = F)
setwd("./ldpsa")
dir.create("Results", showWarnings = F)

# LDPSA data download from https://osf.io/yr8ua/
osf_retrieve_file("yr8ua") %>% osf_download(conflicts = "overwrite")
unzip("LDPSA_60.zip", overwrite = T)
ldps <- read.table("LDPSA_60.csv", header=T, sep=",")

# Main wrangling steps
fractions <- c("sand", "silt", "clay")
cdat <- as.data.frame(acomp(ldps[fractions], total=100))

# Isometric log ratio (ilr) transforms
bpart <- t(matrix(c( 1,-1,-1,
                     0, 1,-1), ncol=3, nrow=2, byrow=T))

idat <- as.data.frame(ilr(cdat, V=bpart))
names(idat) <- c("ilr1", "ilr2")
ldps <- cbind(ldps, idat)

# Mean Weight Diameter calculation (micrometers)
ldps$mwd <- exp(0.01*(ldps$clay*log(0.001) + ldps$silt*log(0.026) + ldps$sand*log(1.025)))*1000

# load and merge moderator variables
cvar <- read.table("LDPSA_covar.csv", header=T, sep=",")
ldps <- merge(ldps, cvar, by="ssid")

# Display dataframe structure
str(ldps)
```

The data were sampled from 60, 10 × 10 km sentinel sites (or landscapes, [Vagen et. al., 2015](https://www.sciencedirect.com/science/article/pii/S0016706115300082)) in proportion to their occurrence in the major [Köppen-Geiger](http://koeppen-geiger.vu-wien.ac.at/) climate zones of Africa excluding deserts, urban and other non-photosynthetically active land areas. Each sentinel site represents a 100 km^2^ area, each with a total of 160, georeferenced soil profile sampling locations within each sentinel site. A randomly selected ~10% subset of (1,891 / 19,200) soil samples were analyzed with LDPSA using 9 dispersion treatments described by:

* dispersant, `disp` = in air, water or calgon, and
* sonication time, `stime` = 0, 0.5, 2 or 4 minutes for samples that were dispersed in either water or calgon.

We shall be using only 3 laboratory treatments here to describe, model and interpret soil aggregate stability. Those treatments include: 

* dispersal in calgon (with 4 minutes of sonication, `trt = c4`). These are the housekeeping or ([internal reference](https://link.springer.com/article/10.1007/s00769-013-0955-1)) LDPSA measurements.
* dispersal in water (without sonication, `trt = w1`), and
* dispersal in air (without sonication, `trt = a`). 

The data also contain the following main grouping factors for the random-effects and meta-regression analyses that are presented here:

* sentinel site, `site` = `r length(unique(ldps$site))`
* georeferenced soil profile id in site, `pid` = `r length(unique(ldps$pid))`
* soil sample id in profile, `ssid` = `r length(unique(ldps$ssid))`

Finally the data also contain the following moderator variables:

* available water holding capacities (`awc1` at field capacity & `awc2` at wilting point, m^3^ m^-3^)
* pH (in water)
* electrical conductivity (`ec`, dS m^-1^)
* effective cation exchange capacity (`ecec`, cmol~c~ kg^-1^)
* soil organic carbon content (`soc`, g kg^-1^)

## Spatial distribution of soil samples

```{r}
# Select soil sample  locations 
loc <- subset(ldps, trt == "c4", select=c(ssid, lat, lon))

# Plot sample locations
w <- leaflet() %>%
  setView(lng = mean(loc$lon), lat = mean(loc$lat), zoom = 4) %>%
  addProviderTiles(providers$OpenStreetMap.Mapnik) %>%
  addCircleMarkers(loc$lon, loc$lat, clusterOptions = markerClusterOptions())
w ## plot widget 
```

## Soil particle size fractions by treatment combinations

```{r}
water <- subset(ldps, disp == "water", select=c(sand, clay, silt, stime, mwd)) 

wtex_son <- ggtern(
  data = water, aes(x = sand, y = clay, z = silt))+
  geom_point(aes(color = stime), size= 1, alpha = 0.5)+
  scale_color_continuous(low = "dodgerblue", high = "tomato")+
  labs(color = "Sonication time (minutes)")+
  theme_bw()+
  theme(legend.justification = c(0, 1), 
        legend.position      = c(0, 1))

wtex_mwd <- ggtern(
  data = water, aes(x = sand, y = clay, z = silt))+
  geom_point(aes(color = mwd), size = 1, alpha = 0.5)+
  scale_color_continuous(low="dodgerblue", high="tomato")+
  labs(color="MWD (microns)")+
  theme_bw()+
  theme(legend.justification = c(0, 1), 
        legend.position      = c(0, 1))
```

Note that an identical chunk is replicated for the samples that were dispersed in calgon. This is not included in the html here to keep the text concise. However, it is included in the actual R-markdown doc on [Github](). The chunks generate ternary plots using the `ggtern` package in R-markdown. The figures appear convincing in that as a whole they show that dispersion in both water and calgon work in the expected direction in response to the combination of the dispersant and the sonication treatments.

```{r, echo = FALSE}
calgon <- subset(ldps, disp == "calgon", select=c(sand, clay, silt, stime, mwd))

ctex_son <- ggtern(
  data = calgon, aes(x = sand, y = clay, z = silt))+
  geom_point(aes(color = stime), size= 1, alpha = 0.5)+
  scale_color_continuous(low = "dodgerblue", high = "tomato")+
  labs(color = "Sonication time (minutes)")+
  theme_bw()+
  theme(legend.justification = c(0, 1), 
        legend.position      = c(0, 1))

ctex_mwd <- ggtern(
  data = calgon, aes(x = sand, y = clay, z = silt))+
  geom_point(aes(color = mwd), size = 1, alpha = 0.5)+
  scale_color_continuous(low="dodgerblue", high="tomato")+
  labs(color="MWD (microns)")+
  theme_bw()+
  theme(legend.justification = c(0, 1), 
        legend.position      = c(0, 1))
```

```{r, echo = FALSE, fig.align = "center", fig.show = 'hold', out.width = "50%", fig.cap = "**Figure 1:** Ternary plots of the particle size distributions of LDPSA samples dispersed in either in water (top) or calgon (bottom). Color coded by mean weight diameter (`mwd`, left), and sonication time (`stime`, right)."}

wtex_mwd
wtex_son
ctex_mwd
ctex_son
```

```{r, echo = FALSE, fig.align = "center", fig.show='hold', fig.cap = "**Figure 2:** Empirical cumulative distributions of LDPSA treatment in calgon, water qnd air. The subsamples shown in red were dispersed in calgon with 4 minutes of sonication; the subsamples in blue were dispersed in water without sonication, and the subsamples in green were dispersed in air without sonication."}

# Select dispersion treatment endpoints
c4 <- subset(ldps, trt=="c4", select=c(sand, silt, clay, ilr1, ilr2, mwd)) 
w1 <- subset(ldps, trt=="w1", select=c(sand, silt, clay, ilr1, ilr2, mwd))
air <- subset(ldps, trt=="a", select=c(sand, silt, clay, ilr1, ilr2, mwd)) 

# Sand
par(mfrow=c(2,3), pty="s", mar=c(2,4,1,2))
plot(ecdf(c4$sand), main="", xlab="Sand (%)", ylab="ECDF", xlim=c(0, 100),
     verticals=T, lty=1, lwd=2, cex.lab=1.3, col="tomato", do.points=F)
abline(0.5,0, lty=1, col="grey")
plot(ecdf(w1$sand), add=T, verticals=T, lty=1, lwd=2, col="dodgerblue", do.points=F)
plot(ecdf(air$sand), add=T, verticals=T, lty=1, lwd=2, col="dark green", do.points=F)

# Silt
plot(ecdf(c4$silt), main="", xlab="Silt (%)", ylab="", xlim=c(0, 100), verticals=T,
     lty=1, lwd=2, cex.lab=1.3, col="tomato", do.points=F)
abline(0.5,0, lty=1, col="grey")
plot(ecdf(w1$silt), add=T, verticals=T, lty=1, lwd=2, col="dodgerblue", do.points=F)
plot(ecdf(air$silt), add=T, verticals=T, lty=1, lwd=2, col="dark green", do.points=F)

# Clay
plot(ecdf(c4$clay), main="", xlab="Clay (%)", ylab="", xlim=c(0, 100), verticals=T,
     lty=1, lwd=2, cex.lab=1.3, col="tomato", do.points=F)
abline(0.5,0, lty=1, col="grey")
plot(ecdf(w1$clay), add=T, verticals=T, lty=1, lwd=2, col="dodgerblue", do.points=F)
plot(ecdf(air$clay), add=T, verticals=T, lty=1, lwd=2, col="dark green", do.points=F)

# Mean weight diameter
plot(ecdf(c4$mwd), main="", xlab="MWD (microns)", ylab="ECDF", xlim=c(0, 800),
     verticals=T, lty=1, lwd=2, cex.lab=1.3, col="tomato", do.points=F)
abline(0.5,0, lty=1, col="grey")
plot(ecdf(w1$mwd), add=T, verticals=T, lty=1, lwd=2, col="dodgerblue", do.points=F)
plot(ecdf(air$mwd), add=T, verticals=T, lty=1, lwd=2, col="dark green", do.points=F)

# ILR1 (sand | silt, clay)
plot(ecdf(c4$ilr1), main="", xlab="ILR1 (sand | silt, clay)", ylab="",
     xlim=c(-6, 6), verticals=T, lty=1, lwd=2, cex.lab=1.3, col="tomato", do.points=F)
abline(0.5,0, lty=1, col="grey")
plot(ecdf(w1$ilr1), add=T, verticals=T, lty=1, lwd=2, col="dodgerblue", do.points=F)
plot(ecdf(air$ilr1), add=T, verticals=T, lty=1, lwd=2, col="dark green", do.points=F)

# ILR2 (silt | clay)
plot(ecdf(c4$ilr2), main="", xlab="ILR2 (silt | clay)", ylab="",
     xlim=c(-4, 4), verticals=T, lty=1, lwd=2, cex.lab=1.3, col="tomato", do.points=F)
abline(0.5,0, lty=1, col="grey")
plot(ecdf(w1$ilr2), add=T, verticals=T, lty=1, lwd=2, col="dodgerblue", do.points=F)
plot(ecdf(air$ilr2), add=T, verticals=T, lty=1, lwd=2, col="dark green", do.points=F)
```

The message conveyed by the graphs above is that 4 minutes of sonication in calgon is quite effective in destroying air-dry soil aggregates. The two isometric log ratios of the particle size data (`ilr1` & `ilr2`) and the mean weight diameter (`mwd`) graphs also demonstrate the ordinality of these treatments quite well. Subsamples analyzed in air were minimally dispersed; subsamples analyzed in water (without sonication) were moderately dispersed, and subsamples dispersed in calgon with 4 minutes of sonication were strongly dispersed.

## Calculation of cumulative link indices

```{r}
# Select dispersal treatment subset
ldps_end <- subset(ldps, trt=="c4" | trt=="w1" | trt=="a", 
                   select=c(site, pid, ssid, trt, topsub, sand, silt, clay, ilr1, ilr2, mwd))

# Set dispersal treatment as an ordered factor
ldps_end$trt <- factor(ldps_end$trt, ordered = TRUE, levels = c("c4", "w1", "a"))

# Fit clms
cl0 <- clm(trt~log(mwd), data = ldps_end)
cl1 <- clm(trt~ilr1+ilr2, data = ldps_end)
cl2 <- clm(trt~ilr1*ilr2, data = ldps_end)
wgt <- as.vector(coef(cl1))
ldps_end$cli <- wgt[3]*ldps_end$ilr1 + wgt[4]*ldps_end$ilr2
```

```{r, echo = FALSE, results = 'hide'}
anova(cl0, cl1, cl2)
```

```{r, echo = FALSE, results = 'hide'}
site <- clmm(trt~ilr1+ilr2 + (1|site), data = ldps_end)
summary(site)
anova(cl1, site)
```

```{r}
# merge to wide format
c4 <- subset(ldps_end, trt=="c4")
c4 <- aggregate(c4$cli, list(c4$site, c4$pid), FUN = mean)
w1 <- subset(ldps_end, trt=="w1")
w1 <- aggregate(w1$cli, list(w1$site, w1$pid), FUN = mean)
air <- subset(ldps_end, trt=="a")
air <- aggregate(air$cli, list(air$site, air$pid), FUN = mean)

# calculate soil profile-level deltas from the c4 housekeeping treatment
del <- merge(c4, w1, by = "Group.2")
del <- merge(del, air, by = "Group.2")
del <- del[c(2,1,3,5,7)]
names(del) <- c("site","profile","c4","w1","air")
del$dw <- del$w1 - del$c4
del$da <- del$air - del$c4

# calculate dispersion/flocculation index (dfi)
del$dfi <- del$dw - del$da
```

```{r, fig.align ="center", fig.show='hold', out.width="50%", fig.cap="**Figure 3:** Empirical cumulative distributions of delta index values relative to dispersion in calgon with 4 minutes of sonication (Δc4). The subsamples shown in green were dispersed in air; the subsamples in blue were dispersed in water. In red the dispersion/flocculation index (DFI) i.e., the difference between subsamples dispersed in water and in air (normalized by their Δc4 values)."}

# cumulative distributions of delta values 
par(pty="s", mar=c(4,4,1,1))

plot(ecdf(del$da), main="", xlab="Δc4 cumulative link index", ylab="ECDF",
     xlim=c(-5, 15), verticals=T, lty=1, lwd=2, cex.lab=1.3, col="dark green", do.points=F)
plot(ecdf(del$dw), add=T, verticals=T, lty=1, lwd=2, col="dodgerblue", do.points=F)
abline(0.5,0, lty=1, col="grey")
w <- quantile(del$dw, probs = 0.5)
a <- quantile(del$da, probs = 0.5)
abline(v = w, lty=1, col = "dark grey")
abline(v = a, lty=1, col = "dark grey")

# cumulative distribution of dw - da
plot(ecdf(del$dfi), main="", xlab=expression(paste("DFI ",("Δc4"[water] - "Δc4"[air]))), ylab="ECDF",
     xlim=c(-10, 5), verticals=T, lty=1, lwd=2, cex.lab=1.3, col="tomato", do.points=F)
abline(0.5,0, lty=1, col = "dark gray")
abline(v = 0, lty=1, col = "dark gray")
m <- quantile(del$dfi, probs = 0.5)
abline(v = m, lty=1, col = "dark grey")
```

# Landscape-level aggregate stabilities

```{r}
dn <- aggregate(del$dfi, list(del$site), FUN = length)
dm <- aggregate(del$dfi, list(del$site), FUN = mean)
ds <- aggregate(del$dfi, list(del$site), FUN = sd)
sdel <- cbind(dn, dm[2], ds[2])
names(sdel) <- c("site", "n", "yi", "sd")
```

# Takeaways

Dispersion/flocculation are chemical processes that are primarily driven by the balance of cations in the soil. Calcium has very high flocculation power, whereas sodium and potassium cause dispersion. The general balance between Ca and Mg compared to sodium is what determines aggregate stability. The use of fertilizers, over-application of compost, or the use of poor irrigation water—will cause dispersion. Alternatively, too little calcium may be the issue, making soil testing and mineral amendments of utmost importance in low pH soils.

